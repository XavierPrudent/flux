---
title: "Résumé de performances"
author: "Civilia - Xavier Prudent"
date: "November 3, 2017"
output:
    html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=F, out.width = "400px", include=T,warning=F,message=F,fig.align='center'}
## Logo de Civilia
logo.png <- "/Users/lavieestuntoucan/Civilia/projets/Saguenay/tech/CIVILIA_logo_couleur_mac.png"
knitr::include_graphics(logo.png)
```

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
source("/Users/lavieestuntoucan/Civilia/tech/general/load_R_pkg.R")
```

Ce rapport résume les performances du transport collectif dans la MRC Montcalm entre 2009 et 2017. Dans la perspective d'un service régulier, seuls les déplacements non adaptés ont été pris en compte dans cette étude (82\% du total des déplacements durant cette période).

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
path.src <- "/Users/lavieestuntoucan/civ-montcalm/tech/calcul-reseau/R/"
path.in <- "/Users/lavieestuntoucan/civ-montcalm/data/data-for-server/"
path.out <- "/Users/lavieestuntoucan/civ-montcalm/tech/calcul-reseau/out/2009-2017/"
## Coords Montcalm
coord <- data.frame(lon=-73.666439,lat=45.926373)
##
source(paste0(path.src,"include_spatialFunctions.R"))
##
in.data.1 <- paste0(path.out,"uniqTrips_df.rds")
in.data.2 <- paste0(path.out,"allTrips_spldf.rds")
in.data.3 <- paste0(path.out,"network_spldf.rds")
##
uniq.trips <- readRDS(in.data.1)
all.trips <- readRDS(in.data.2)
ntw <- readRDS(in.data.3)
##
## Cleaned full data
in.data.1 <- "/Users/lavieestuntoucan/civ-montcalm/data/data-for-server/Transport_MRC_Montcalm_cleaned.Rds"
d <- readRDS(in.data.1)
d <- d %>% 
  filter(MoyenTransport != "MINIBUS AD. OU TAXI ADAPTÉ" & MoyenTransport != "VAN ADAPTÉ" ) %>%
  dplyr::select(DateTransport,HeureDepart,AdresseDepart,AdresseArrivee,
                MunicipaliteDepart,MunicipaliteArrivee,Montant,
                TypeCommentaire,MoyenTransport) %>% 
  mutate(dateDepart = fastPOSIXct(paste0(DateTransport," ",format(HeureDepart,"%H:%M:%S")),tz="GMT") ) %>% dplyr::select(-DateTransport,-HeureDepart)
##
d <- d %>% mutate(date=as.Date(dateDepart)) %>% 
  mutate(month = months(date), weekday = weekdays(date), year = year(date)) %>%
  mutate(hour = hour(dateDepart))

month.eng <- c("January","February","March","April","May","June","July","August","September","October","November","December" )
month.fr <- c("Janvier","Févier","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre" )
week.eng <- c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")
week.fr <- c("Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche")

for( i in 1:length(month.eng)) d <- d %>% mutate(month = gsub(month.eng[i], month.fr[i], month))
for( i in 1:length(week.eng)) d <- d %>% mutate(weekday = gsub(week.eng[i], week.fr[i], weekday))
```

# Évolution de la demande entre 2009 et 2017

Évolution du nombre de déplacements de 2009 à 2017. Le nombre total de voyages est ramené au nombre moyen par jour en considérant les jours d'opération (rouge : 365 jours, orange : 252 jours, soit les jours ouvrables) :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% group_by(year) %>% summarise(n=length(unique(date)))

ggplot(data=df, aes(x = as.factor(year), y=n, group=1)) +
  geom_point() +
  geom_line() +
  xlab("Années") +
  ylab("Nombre de jours d'opération") +
  geom_hline(yintercept=365, col="red") +
  geom_hline(yintercept=252, col="orange") +
  ylim(c(210,370))
```

## Par année

Nombre total de déplacements par années :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
ggplot() +
  geom_bar(data=d, aes(x = as.factor(year))) +
  xlab("Années") +
  ylab("Nombre de voyages total")
```

Nombre de déplacements moyen par jour d'opération par années :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% group_by(year) %>% 
  summarise(n.op=length(unique(date)), n.voy = n()) %>% 
  mutate(n.moyen = round(n.voy/n.op))

ggplot(data=df, aes(x = as.factor(year), y = n.moyen, group=1)) +
  geom_point() +
  geom_line() +
  xlab("Années") +
  ylab("Nombre de voyages moyen par jour d'opération")
```

Variation de la demande avec les saisons et les périodes scolaires (été, fêtes de fin d'année, rentrée) :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
ggplot() +
  geom_histogram(data=d, aes(x=date), binwidth = 30) +
  scale_x_date(breaks =  date_breaks("1 year"),
               labels = date_format("%Y")) +
  xlab("Années") +
  ylab("Nombre de voyages")
```

## Par mois

Nombre total de déplacements par mois  :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
ggplot() +
  geom_bar(data=d, aes(x = as.factor(month))) +
  xlab("Mois") +
  ylab("Nombre de voyages") +
  scale_x_discrete(limits=month.fr)
```

Nombre de déplacements moyen par jour d'opération par mois :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% group_by(month) %>% 
  summarise(n.op=length(unique(date)), n.voy = n()) %>% 
  mutate(n.moyen = round(n.voy/n.op))

ggplot(data=df, aes(x = as.factor(month), y = n.moyen, group=1)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(from=min(df$n.moyen), max(df$n.moyen), by=2)) +
  xlab("Mois") +
  ylab("Nombre de voyages moyen par jour d'opération") +
  scale_x_discrete(limits=month.fr)

```

## Durant la semaine

Nombre de déplacements moyen par jour d'opération au cours de la semaine :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% group_by(weekday) %>% 
  summarise(n.op=length(unique(date)), n.voy = n()) %>% 
  mutate(n.moyen = round(n.voy/n.op))

ggplot(data=df, aes(x = as.factor(weekday), y = n.moyen, group=1)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(from=min(df$n.moyen), max(df$n.moyen), by=2)) +
  scale_x_discrete(limits=week.fr) +
  xlab("Jour de la semaine") +
  ylab("Nombre de voyages moyen par jour d'opération")
```

## Par heure

Nombre de déplacements moyen par heure d'opération :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% group_by(hour) %>% 
  summarise(n.op=length(unique(date)), n.voy = n()) %>% 
  mutate(n.moyen = round(n.voy/n.op))

ggplot(data=df, aes(x = as.factor(hour), y = n.moyen, group=1)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(from=min(df$n.moyen), max(df$n.moyen), by=1)) +
  xlab("Heure de la journée") +
  ylab("Nombre de voyages moyen par heure")
```

Nombre de déplacements moyen par heure d'opération durant la semaine (mardi, mercredi, jeudi) :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% filter(weekday == "Mardi" |
                     weekday == "Mercredi" |
                     weekday == "Jeudi" ) %>%
  group_by(hour) %>% 
  summarise(n.op=length(unique(date)), n.voy = n()) %>% 
  mutate(n.moyen = round(n.voy/n.op))

ggplot(data=df, aes(x = as.factor(hour), y = n.moyen, group=1)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(from=min(df$n.moyen), max(df$n.moyen), by=1)) +
  xlab("Heure de la journée (semaine : Ma., Me., Je.)") +
  ylab("Nombre de voyages moyen par heure")
```

Nombre de déplacements moyen par heure d'opération durant la fin de semaine (samedi, dimanche) :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% filter(weekday == "Samedi" |
                     weekday == "Dimanche") %>%
  group_by(hour) %>% 
  summarise(n.op=length(unique(date)), n.voy = n()) %>% 
  mutate(n.moyen = round(n.voy/n.op))

ggplot(data=df, aes(x = as.factor(hour), y = n.moyen, group=1)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(from=min(df$n.moyen), max(df$n.moyen), by=1)) +
  xlab("Heure de la journée (fin de semaine") +
  ylab("Nombre de voyages moyen par heure")
```

# Évolution du montant payé par les usagers

Montant moyen par années :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
df <- d %>% group_by(year) %>% 
  summarise(n=mean(Montant))

ggplot(data=df, aes(x = as.factor(year), y = n, group=1)) +
  geom_point() +
  geom_line() +
  xlab("Années") +
  ylab("Montant moyen payé par les usagers (dollar)")
```

Distribution du montant payé par les usagers :

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='65%'}
ggplot(data=d, aes(x = Montant)) +
  geom_histogram() +
  xlab("Montant payé par les usagers (dollar) LOG") +
  ylab("Nombre de paiements") +
  scale_y_log10(breaks=c(1,10,100,1000)) +
  scale_x_continuous(breaks=seq(from=0,to=max(d$Montant),by=10)) 
```

# Réseau des déplacements

## Réseau total 2009-2017

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='100%'}

map.city <- leaflet() %>%
  addTiles('http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=68c4cd328d3b484091812a76fae093fd') %>%
  setView(coord$lon, coord$lat, zoom = 11)
path.out <- "/Users/lavieestuntoucan/civ-montcalm/tech/calcul-reseau/out/"

## Loop over the years to compare the evolution
  ## Extract data
  in.data.3 <- paste0(path.out,"2009-2017/network_spldf.rds")
  ntw <- readRDS(in.data.3)
  ntw.dat <- ntw@data
  ntw.lines <- ntw@lines 
  
  ## Loop over lines
  for( i in 1:length(ntw.lines)){
    i.x <- ntw.lines[[i]]@Lines[[1]]@coords[,1]
    i.y <- ntw.lines[[i]]@Lines[[1]]@coords[,2]
    i.n <- ntw.dat$n.per.day[i]
    i.col <- col.n(i.n)
    if( i == 1 ){
        MAP <- map.city
    } else {
      MAP <- map1
    }
    map1 <- addPolylines(MAP,lng = i.x,lat = i.y,col=i.col,opacity=1, label=paste(round(i.n),"/jour"))
  }

map1 

```

## Évolution du réseau de 2009 à 2017

```{r, echo=F, include=T,warning=F,message=F,fig.align='center', out.width='100%'}

map.city <- leaflet() %>%
  addTiles('http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=68c4cd328d3b484091812a76fae093fd') %>%
  setView(coord$lon, coord$lat, zoom = 11)
path.out <- "/Users/lavieestuntoucan/civ-montcalm/tech/calcul-reseau/out/"

## Loop over the years to compare the evolution
for( i.year in 2009:2017 ){
  i.year <- as.character(i.year)
  
  ## Extract data
  in.data.3 <- paste0(path.out,i.year,"/network_spldf.rds")
  ntw <- readRDS(in.data.3)
  ntw.dat <- ntw@data
  ntw.lines <- ntw@lines 
  
  ## Loop over lines
  for( i in 1:length(ntw.lines)){
    i.x <- ntw.lines[[i]]@Lines[[1]]@coords[,1]
    i.y <- ntw.lines[[i]]@Lines[[1]]@coords[,2]
    i.n <- ntw.dat$n.per.day[i]
    i.col <- col.n(i.n)
    if( i == 1 & i.year == "2009" ){
        MAP <- map.city
    } else {
      MAP <- map1
    }
    map1 <- addPolylines(MAP,lng = i.x,lat = i.y,col=i.col,opacity=1, group=i.year, label=paste(round(i.n),"/jour"))
  }
}

## Add layers
map1 <- map1 %>% addLayersControl(baseGroups = as.character(2009:2017),
                                  options = layersControlOptions(collapsed = FALSE))
map1

```

<br><br>


